<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Datos | LavaSmart</title>
  <base target="_top">

  <!-- Google Fonts - Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'outfit': ['Outfit', 'sans-serif'] },
          colors: {
            'lava': {
              50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
              400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
              800: '#115e59', 900: '#134e4a',
            }
          }
        }
      }
    }
  </script>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { font-family: 'Outfit', sans-serif; }
    body { padding-top: 4.5rem; background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 50%, #99f6e4 100%); min-height: 100vh; }
    .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .main-container { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    .kpi-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,253,250,0.95) 100%); transition: all 0.3s ease; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(13, 148, 136, 0.1); }
    .kpi-card.warning { border-left: 4px solid #f59e0b; }
    .kpi-card.success { border-left: 4px solid #10b981; }
    .kpi-card.danger { border-left: 4px solid #ef4444; }
    .kpi-card.info { border-left: 4px solid #0d9488; }
    
    table.dataTable { border-collapse: collapse !important; width: 100% !important; }
    table.dataTable thead th { background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%) !important; color: white !important; font-weight: 600 !important; padding: 12px 14px !important; border: none !important; font-size: 12px !important; text-transform: uppercase !important; }
    table.dataTable tbody tr { transition: all 0.2s ease; }
    table.dataTable tbody tr:nth-child(even) { background-color: #f0fdfa !important; }
    table.dataTable tbody tr:hover { background-color: #ccfbf1 !important; cursor: pointer; }
    table.dataTable tbody td { color: #115e59 !important; padding: 10px 14px !important; border-bottom: 1px solid #e5e7eb !important; font-size: 13px !important; }
    
    .dataTables_wrapper .dataTables_filter input { border: 2px solid #e5e7eb !important; border-radius: 8px !important; padding: 6px 10px !important; }
    .dataTables_wrapper .dataTables_filter input:focus { border-color: #14b8a6 !important; outline: none !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { border-radius: 6px !important; margin: 0 2px !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover, .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%) !important; color: white !important; border: none !important; }
    
    .filter-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
    
    #loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(240, 253, 250, 0.95); backdrop-filter: blur(5px); z-index: 999; display: flex; align-items: center; justify-content: center; }
    #loader.hidden { display: none; }
    
    .modal-overlay { background: rgba(15, 118, 110, 0.3); backdrop-filter: blur(5px); }
    .modal-content { background: linear-gradient(135deg, #ffffff 0%, #f0fdfa 100%); }
    .modal-section { background: rgba(240, 253, 250, 0.7); border: 1px solid rgba(20, 184, 166, 0.1); }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    .tab-btn { transition: all 0.2s ease; }
    .tab-btn.active { background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%); color: white; }
  </style>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <script>
    // Variables globales
    var filterOptions = { paymentMethods: [], paymentStatuses: [], vendors: [], saleTypes: [] };
    var currentFilters = { text: '', day: '', start: '', end: '', isRange: false, paymentMethod: 'all', paymentStatus: 'all', vendor: 'all' };

    function formatDateInput(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }
    function todayString() { return formatDateInput(new Date()); }
    function daysAgoString(n) { var d = new Date(); d.setDate(d.getDate() - n); return formatDateInput(d); }

    function showNotification(message, type) {
      var bgColor = type === 'error' ? 'bg-red-500' : (type === 'warning' ? 'bg-amber-500' : 'bg-lava-500');
      var notification = $('<div class="fixed top-20 right-4 ' + bgColor + ' text-white px-5 py-3 rounded-xl shadow-lg z-[1000] animate-fade-in flex items-center gap-3"><i class="fas fa-' + (type === 'error' ? 'exclamation-circle' : 'check-circle') + '"></i>' + message + '</div>');
      $('body').append(notification);
      setTimeout(function() { notification.fadeOut(function() { $(this).remove(); }); }, 3500);
    }

    function handleError(error) {
      console.error('Error:', error);
      $("#loader").addClass("hidden");
      showNotification('Error al cargar datos', 'error');
    }

    function navigateToPage(page) {
      google.script.run
        .withSuccessHandler(function(baseUrl) {
          var url = page === 'dashboard' ? baseUrl + '?page=dashboard' : baseUrl;
          window.open(url, '_top');
        })
        .withFailureHandler(function(error) {
          window.open(page === 'dashboard' ? '?page=dashboard' : '?', '_top');
        })
        .getScriptUrl();
    }

    function updateCurrentFilters() {
      currentFilters = {
        text: $("#search-text").val().trim(),
        day: $("#filter-day").val(),
        start: $("#filter-start").val(),
        end: $("#filter-end").val(),
        isRange: $("#range-mode").is(":checked"),
        paymentMethod: $("#filter-payment-method").val() || 'all',
        paymentStatus: $("#filter-payment-status").val() || 'all',
        vendor: $("#filter-vendor").val() || 'all'
      };
    }

    function fetchAllData() {
      $("#loader").removeClass("hidden");
      updateCurrentFilters();
      
      var filterType = currentFilters.isRange ? 'range' : (currentFilters.day ? 'day' : 'all');
      var startDate = currentFilters.isRange ? currentFilters.start : currentFilters.day;
      var endDate = currentFilters.isRange ? currentFilters.end : '';

      // Obtener KPIs financieros
      google.script.run
        .withSuccessHandler(showFinancialKpis)
        .withFailureHandler(handleError)
        .getFinancialKpis(currentFilters.text, startDate, endDate, filterType, 
                          currentFilters.paymentMethod, currentFilters.paymentStatus, currentFilters.vendor);

      // Obtener datos filtrados
      google.script.run
        .withSuccessHandler(displayData)
        .withFailureHandler(handleError)
        .getAdvancedFilteredData(currentFilters.text, startDate, endDate, filterType,
                                  currentFilters.paymentMethod, currentFilters.paymentStatus, currentFilters.vendor);
    }

    function showFinancialKpis(kpi) {
      // KPIs principales
      animateNumber("#kpi-total", kpi.totalRecords, false);
      animateNumber("#kpi-total-revenue", kpi.totalRevenue, true);
      animateNumber("#kpi-avg-revenue", kpi.avgRevenue, true);
      
      // KPIs financieros
      animateNumber("#kpi-paid", kpi.totalPaid, true);
      animateNumber("#kpi-pending-amount", kpi.totalPending, true);
      animateNumber("#kpi-tips", kpi.totalTips, true);
      animateNumber("#kpi-pending-count", kpi.pendingCount + kpi.noPaymentInfoCount, false);
      animateNumber("#kpi-paid-count", kpi.paidCount, false);
      
      // Porcentaje de cobro
      var paidPct = kpi.totalRecords > 0 ? Math.round((kpi.paidCount / kpi.totalRecords) * 100) : 0;
      $("#kpi-paid-pct").text(paidPct + '%');
      $("#paid-progress").css('width', paidPct + '%');
    }

    function animateNumber(selector, target, isCurrency) {
      var $el = $(selector);
      var duration = 600, steps = 20;
      var current = 0, increment = target / steps, interval = duration / steps;
      var timer = setInterval(function() {
        current += increment;
        if (current >= target) { current = target; clearInterval(timer); }
        $el.text(isCurrency ? formatMoney(current) : Math.round(current).toLocaleString('es-MX'));
      }, interval);
    }

    function formatMoney(n) {
      return '$' + n.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function displayData(jsonData) {
      $("#loader").addClass("hidden");
      var parsedData = [];
      try { parsedData = JSON.parse(jsonData); } catch (e) { console.error('Error parsing:', e); }

      var thead = '<thead><tr><th>Folio</th><th>Fecha</th><th class="hidden md:table-cell">Cliente</th><th class="hidden lg:table-cell">Servicio</th><th>Monto</th><th class="hidden md:table-cell">Método</th><th>Estado Pago</th></tr></thead><tbody>';
      var tbody = '';
      
      parsedData.forEach(function(row, idx) {
        var payStatus = row[16] || '';
        var statusClass = getPaymentStatusClass(payStatus);
        tbody += '<tr data-row-index="' + idx + '">';
        tbody += '<td><span class="font-medium text-lava-700">' + (row[0] || '') + '</span></td>';
        tbody += '<td>' + (row[1] || '') + '</td>';
        tbody += '<td class="hidden md:table-cell">' + (row[2] || '') + '</td>';
        tbody += '<td class="hidden lg:table-cell max-w-[150px] truncate">' + (row[27] || '') + '</td>';
        tbody += '<td><span class="font-semibold text-lava-700">' + (row[8] || '') + '</span></td>';
        tbody += '<td class="hidden md:table-cell">' + (row[15] || '—') + '</td>';
        tbody += '<td><span class="px-2 py-1 rounded-full text-xs font-medium ' + statusClass + '">' + (payStatus || 'Sin registrar') + '</span></td>';
        tbody += '</tr>';
      });
      
      $("#dataTable").html(thead + tbody + '</tbody>');

      if ($.fn.DataTable.isDataTable("#dataTable")) { window.myDataTable.destroy(); }
      window.myDataTable = $("#dataTable").DataTable({
        order: [[1, 'desc']], pageLength: 25, responsive: true, autoWidth: false,
        language: {
          search: "", searchPlaceholder: "Buscar...", lengthMenu: "Mostrar _MENU_",
          paginate: { first: '<i class="fas fa-angle-double-left"></i>', last: '<i class="fas fa-angle-double-right"></i>', next: '<i class="fas fa-angle-right"></i>', previous: '<i class="fas fa-angle-left"></i>' },
          info: "_START_-_END_ de _TOTAL_", infoEmpty: "Sin registros", zeroRecords: "Sin resultados"
        }
      });

      window.originalTableData = parsedData;
      $("#dataTable tbody").off("click").on("click", "tr", function() {
        var rowIndex = $(this).data("row-index");
        if (rowIndex !== undefined) openModal(rowIndex);
      });
    }

    function getPaymentStatusClass(status) {
      if (!status) return 'bg-gray-100 text-gray-600';
      var s = status.toString().toLowerCase();
      if (s.includes('pagado') || s.includes('cobrado')) return 'bg-green-100 text-green-700';
      if (s.includes('pendiente') || s.includes('por pagar')) return 'bg-amber-100 text-amber-700';
      if (s.includes('cancelado')) return 'bg-red-100 text-red-700';
      return 'bg-gray-100 text-gray-600';
    }

    function openModal(idx) {
      var data = window.originalTableData[idx];
      var ubic = [data[34], data[35], data[36], data[37], data[38]].filter(function(v) { return v && v.toString().trim(); }).join(", ");
      
      var html = '<div class="flex justify-between items-center border-b border-lava-200 pb-4 mb-6">' +
        '<h3 class="text-xl font-bold text-lava-800 flex items-center gap-3"><div class="w-9 h-9 bg-lava-100 rounded-lg flex items-center justify-center"><i class="fas fa-file-alt text-lava-600"></i></div>Folio: ' + (data[0] || '—') + '</h3>' +
        '<button id="modal-close-btn" class="w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-500 flex items-center justify-center"><i class="fas fa-times"></i></button></div>' +
        
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
        '<section class="modal-section rounded-xl p-4"><h4 class="text-sm font-semibold text-lava-700 mb-3"><i class="fas fa-user mr-2"></i>Cliente</h4>' +
        '<div class="space-y-2 text-sm"><div><span class="text-gray-500">Nombre:</span> <span class="font-medium">' + (data[2] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Teléfono:</span> <span class="font-medium">' + (data[3] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Fecha:</span> <span class="font-medium">' + (data[1] || '—') + '</span></div></div></section>' +
        
        '<section class="modal-section rounded-xl p-4"><h4 class="text-sm font-semibold text-lava-700 mb-3"><i class="fas fa-dollar-sign mr-2"></i>Pagos</h4>' +
        '<div class="space-y-2 text-sm"><div><span class="text-gray-500">Total:</span> <span class="font-bold text-lg text-lava-700">' + (data[8] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Método:</span> <span class="font-medium">' + (data[15] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Estado:</span> <span class="px-2 py-0.5 rounded text-xs font-medium ' + getPaymentStatusClass(data[16]) + '">' + (data[16] || 'Sin registrar') + '</span></div>' +
        '<div><span class="text-gray-500">Propina:</span> <span class="font-medium">' + (data[6] || '$0') + '</span></div></div></section>' +
        
        '<section class="modal-section rounded-xl p-4"><h4 class="text-sm font-semibold text-lava-700 mb-3"><i class="fas fa-tools mr-2"></i>Servicio</h4>' +
        '<div class="space-y-2 text-sm"><div><span class="text-gray-500">Servicio:</span> <span class="font-medium">' + (data[27] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Vendedor:</span> <span class="font-medium">' + (data[32] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Técnico:</span> <span class="font-medium">' + (data[21] || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Estado:</span> <span class="font-medium">' + (data[33] || '—') + '</span></div></div></section>' +
        
        '<section class="modal-section rounded-xl p-4"><h4 class="text-sm font-semibold text-lava-700 mb-3"><i class="fas fa-map-marker-alt mr-2"></i>Ubicación</h4>' +
        '<div class="space-y-2 text-sm"><div><span class="text-gray-500">Dirección:</span> <span class="font-medium">' + (ubic || '—') + '</span></div>' +
        '<div><span class="text-gray-500">Unidad:</span> <span class="font-medium">' + (data[20] || '—') + '</span></div></div></section></div>';
      
      if (data[28]) {
        html += '<section class="modal-section rounded-xl p-4 mt-4"><h4 class="text-sm font-semibold text-lava-700 mb-2"><i class="fas fa-comment mr-2"></i>Comentarios</h4><p class="text-sm">' + data[28] + '</p></section>';
      }
      
      $("#modal-content").html(html);
      $("#modal-overlay, #modal").removeClass("hidden");
      $("#modal-close-btn").on("click", closeModal);
      $(document).on("keydown.modal", function(e) { if (e.key === "Escape") closeModal(); });
    }
    
    function closeModal() {
      $("#modal-overlay, #modal").addClass("hidden");
      $("#modal-content").empty();
      $(document).off("keydown.modal");
    }

    function exportToCSV() {
      updateCurrentFilters();
      var filterType = currentFilters.isRange ? 'range' : (currentFilters.day ? 'day' : 'all');
      var startDate = currentFilters.isRange ? currentFilters.start : currentFilters.day;
      var endDate = currentFilters.isRange ? currentFilters.end : '';
      
      showNotification('Generando CSV...', 'success');
      google.script.run
        .withSuccessHandler(function(csv) {
          if (!csv) { showNotification('Sin datos', 'warning'); return; }
          var blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
          var url = URL.createObjectURL(blob);
          var link = document.createElement('a');
          link.href = url;
          link.download = 'lavasmart_' + todayString() + '.csv';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showNotification('Descargado', 'success');
        })
        .withFailureHandler(function(e) { showNotification('Error: ' + e.message, 'error'); })
        .exportToCSV(currentFilters.text, startDate, endDate, filterType);
    }

    function loadFilterOptions() {
      google.script.run
        .withSuccessHandler(function(options) {
          filterOptions = options;
          populateFilterDropdowns();
        })
        .withFailureHandler(handleError)
        .getFilterOptions();
    }

    function populateFilterDropdowns() {
      var $method = $("#filter-payment-method");
      var $status = $("#filter-payment-status");
      var $vendor = $("#filter-vendor");
      
      $method.html('<option value="all">Todos los métodos</option>');
      filterOptions.paymentMethods.forEach(function(m) {
        if (m) $method.append('<option value="' + m + '">' + m + '</option>');
      });
      
      $status.html('<option value="all">Todos los estados</option><option value="paid">Pagados</option><option value="pending">Pendientes</option>');
      
      $vendor.html('<option value="all">Todos los vendedores</option>');
      filterOptions.vendors.forEach(function(v) {
        if (v) $vendor.append('<option value="' + v + '">' + v + '</option>');
      });
    }

    function showPendingOnly() {
      $("#filter-payment-status").val('pending');
      fetchAllData();
      showNotification('Mostrando solo pendientes', 'warning');
    }

    $(document).ready(function() {
      // Cargar opciones de filtros
      loadFilterOptions();

      // Botones de filtro rápido
      $("#btn-yesterday").on("click", function() { $("#filter-day").val(daysAgoString(1)); $("#range-mode").prop("checked", false); updateFilterState(); fetchAllData(); });
      $("#btn-today").on("click", function() { $("#filter-day").val(todayString()); $("#range-mode").prop("checked", false); updateFilterState(); fetchAllData(); });
      $("#btn-week").on("click", function() { $("#filter-start").val(daysAgoString(7)); $("#filter-end").val(todayString()); $("#range-mode").prop("checked", true); updateFilterState(); fetchAllData(); });
      $("#btn-month").on("click", function() { $("#filter-start").val(daysAgoString(30)); $("#filter-end").val(todayString()); $("#range-mode").prop("checked", true); updateFilterState(); fetchAllData(); });
      $("#btn-all-time").on("click", function() { $("#filter-day").val(''); $("#filter-start").val(''); $("#filter-end").val(''); $("#range-mode").prop("checked", false); updateFilterState(); fetchAllData(); });

      // Navegación por días
      $("#btn-prev-day").on("click", function() {
        var current = $("#filter-day").val() || todayString();
        var d = new Date(current + 'T12:00:00');
        d.setDate(d.getDate() - 1);
        $("#filter-day").val(formatDateInput(d));
        $("#range-mode").prop("checked", false);
        updateFilterState();
        fetchAllData();
      });
      $("#btn-next-day").on("click", function() {
        var current = $("#filter-day").val() || todayString();
        var d = new Date(current + 'T12:00:00');
        d.setDate(d.getDate() + 1);
        $("#filter-day").val(formatDateInput(d));
        $("#range-mode").prop("checked", false);
        updateFilterState();
        fetchAllData();
      });

      // Toggle rango
      $("#range-mode").on("change", function() { updateFilterState(); fetchAllData(); });

      function updateFilterState() {
        var isRange = $("#range-mode").is(":checked");
        $("#filter-day").prop("disabled", isRange).toggleClass("opacity-50", isRange);
        $("#filter-start, #filter-end").prop("disabled", !isRange).toggleClass("opacity-50", !isRange);
      }

      // Cambios en filtros
      $("#filter-day, #filter-start, #filter-end").on("change", fetchAllData);
      $("#filter-payment-method, #filter-payment-status, #filter-vendor").on("change", fetchAllData);
      $("#search-text").on("input", function() { if (window.myDataTable) window.myDataTable.search(this.value).draw(); });

      // Limpiar filtros
      $("#clear-filter-btn").on("click", function() {
        $("#filter-day, #search-text, #filter-start, #filter-end").val('');
        $("#range-mode").prop("checked", false);
        $("#filter-payment-method, #filter-payment-status, #filter-vendor").val('all');
        updateFilterState();
        fetchAllData();
      });

      // Ver solo pendientes
      $("#btn-pending").on("click", showPendingOnly);

      // Exportar
      $("#btn-export").on("click", exportToCSV);

      // Modal
      $("#modal-overlay").on("click", closeModal);

      // Estado inicial
      updateFilterState();
      var today = todayString();
      $("#filter-day").val(today);
      fetchAllData();
    });
  </script>
</head>

<body class="min-h-screen">
  <!-- Navbar -->
  <nav class="fixed top-0 left-0 w-full glass-card z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <button type="button" onclick="navigateToPage('')" class="flex items-center gap-3 group cursor-pointer bg-transparent border-none">
        <div class="w-10 h-10 bg-gradient-to-br from-lava-500 to-lava-700 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-tint text-white text-lg"></i></div>
        <span class="text-xl font-bold bg-gradient-to-r from-lava-700 to-lava-500 bg-clip-text text-transparent">LavaSmart</span>
      </button>
      <div class="flex items-center gap-2">
        <button type="button" onclick="navigateToPage('')" class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-gradient-to-r from-lava-600 to-lava-500 shadow-md border-none"><i class="fas fa-table mr-2"></i>Consulta</button>
        <button type="button" onclick="navigateToPage('dashboard')" class="px-4 py-2 rounded-lg text-sm font-medium text-lava-700 hover:bg-lava-50 bg-transparent border-none"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-5 animate-fade-in">
      <h1 class="text-2xl md:text-3xl font-bold text-lava-800 mb-1">Consulta de Datos</h1>
      <p class="text-lava-600 text-sm">Análisis financiero y seguimiento de pagos</p>
    </div>

    <!-- KPIs Grid - Financieros -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-5">
      <!-- Total Ingresos -->
      <div class="kpi-card info rounded-xl shadow-md p-4 animate-fade-in">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lava-600 text-xs font-medium uppercase">Ingresos</span>
          <i class="fas fa-coins text-lava-400"></i>
        </div>
        <span id="kpi-total-revenue" class="text-xl font-bold text-lava-800">$0</span>
        <div class="text-xs text-gray-500 mt-1"><span id="kpi-total">0</span> registros</div>
      </div>
      
      <!-- Cobrado -->
      <div class="kpi-card success rounded-xl shadow-md p-4 animate-fade-in">
        <div class="flex items-center justify-between mb-2">
          <span class="text-green-600 text-xs font-medium uppercase">Cobrado</span>
          <i class="fas fa-check-circle text-green-400"></i>
        </div>
        <span id="kpi-paid" class="text-xl font-bold text-green-700">$0</span>
        <div class="text-xs text-gray-500 mt-1"><span id="kpi-paid-count">0</span> pagados</div>
      </div>
      
      <!-- Pendiente -->
      <div class="kpi-card danger rounded-xl shadow-md p-4 animate-fade-in cursor-pointer" onclick="showPendingOnly()">
        <div class="flex items-center justify-between mb-2">
          <span class="text-red-600 text-xs font-medium uppercase">Por Cobrar</span>
          <i class="fas fa-exclamation-circle text-red-400"></i>
        </div>
        <span id="kpi-pending-amount" class="text-xl font-bold text-red-700">$0</span>
        <div class="text-xs text-gray-500 mt-1"><span id="kpi-pending-count">0</span> pendientes</div>
      </div>
      
      <!-- Propinas -->
      <div class="kpi-card warning rounded-xl shadow-md p-4 animate-fade-in">
        <div class="flex items-center justify-between mb-2">
          <span class="text-amber-600 text-xs font-medium uppercase">Propinas</span>
          <i class="fas fa-hand-holding-usd text-amber-400"></i>
        </div>
        <span id="kpi-tips" class="text-xl font-bold text-amber-700">$0</span>
      </div>
      
      <!-- % Cobrado -->
      <div class="kpi-card rounded-xl shadow-md p-4 animate-fade-in col-span-2 md:col-span-1">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lava-600 text-xs font-medium uppercase">% Cobrado</span>
          <span id="kpi-paid-pct" class="text-lg font-bold text-lava-700">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
          <div id="paid-progress" class="bg-gradient-to-r from-green-500 to-emerald-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>Promedio: <span id="kpi-avg-revenue">$0</span></span>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="main-container rounded-2xl shadow-lg p-4 mb-5 animate-fade-in">
      <!-- Filtros rápidos -->
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <span class="text-xs font-medium text-lava-700">Rápido:</span>
        <button id="btn-today" class="px-3 py-1.5 bg-lava-500 text-white rounded-lg hover:bg-lava-600 text-xs font-medium shadow">Hoy</button>
        <button id="btn-yesterday" class="px-3 py-1.5 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-xs font-medium">Ayer</button>
        <button id="btn-week" class="px-3 py-1.5 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-xs font-medium">7 días</button>
        <button id="btn-month" class="px-3 py-1.5 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-xs font-medium">30 días</button>
        <button id="btn-all-time" class="px-3 py-1.5 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-xs font-medium">Todo</button>
        <div class="flex items-center gap-1 ml-2">
          <button id="btn-prev-day" class="w-8 h-8 bg-white border-2 border-lava-200 rounded-lg hover:border-lava-400 flex items-center justify-center"><i class="fas fa-chevron-left text-lava-600 text-xs"></i></button>
          <button id="btn-next-day" class="w-8 h-8 bg-white border-2 border-lava-200 rounded-lg hover:border-lava-400 flex items-center justify-center"><i class="fas fa-chevron-right text-lava-600 text-xs"></i></button>
        </div>
        <button id="btn-pending" class="ml-auto px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-xs font-medium border border-red-200"><i class="fas fa-clock mr-1"></i>Solo Pendientes</button>
      </div>

      <!-- Filtros avanzados -->
      <div class="grid grid-cols-2 md:grid-cols-6 lg:grid-cols-8 gap-3 items-end">
        <div>
          <label class="block text-xs font-medium text-lava-600 mb-1">Día</label>
          <input type="date" id="filter-day" class="w-full px-3 py-2 border-2 border-lava-200 rounded-lg focus:border-lava-400 bg-white text-sm">
        </div>
        <div class="flex items-center gap-2">
          <input id="range-mode" type="checkbox" class="w-4 h-4 text-lava-500 rounded">
          <label for="range-mode" class="text-xs text-lava-600">Rango</label>
        </div>
        <div>
          <label class="block text-xs font-medium text-lava-600 mb-1">Inicio</label>
          <input type="date" id="filter-start" disabled class="w-full px-3 py-2 border-2 border-lava-200 rounded-lg bg-white text-sm opacity-50">
        </div>
        <div>
          <label class="block text-xs font-medium text-lava-600 mb-1">Fin</label>
          <input type="date" id="filter-end" disabled class="w-full px-3 py-2 border-2 border-lava-200 rounded-lg bg-white text-sm opacity-50">
        </div>
        <div>
          <label class="block text-xs font-medium text-lava-600 mb-1">Método Pago</label>
          <select id="filter-payment-method" class="filter-select w-full px-3 py-2 border-2 border-lava-200 rounded-lg bg-white text-sm">
            <option value="all">Todos</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-lava-600 mb-1">Estado Pago</label>
          <select id="filter-payment-status" class="filter-select w-full px-3 py-2 border-2 border-lava-200 rounded-lg bg-white text-sm">
            <option value="all">Todos</option>
            <option value="paid">Pagados</option>
            <option value="pending">Pendientes</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-lava-600 mb-1">Vendedor</label>
          <select id="filter-vendor" class="filter-select w-full px-3 py-2 border-2 border-lava-200 rounded-lg bg-white text-sm">
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button id="clear-filter-btn" class="flex-1 px-3 py-2 bg-gray-100 text-gray-600 font-medium rounded-lg hover:bg-gray-200 text-sm"><i class="fas fa-times"></i></button>
          <button id="btn-export" class="flex-1 px-3 py-2 bg-emerald-500 text-white font-medium rounded-lg hover:bg-emerald-600 shadow text-sm"><i class="fas fa-download"></i></button>
        </div>
      </div>
      
      <!-- Búsqueda de texto -->
      <div class="mt-3">
        <input type="text" id="search-text" placeholder="Buscar cliente, folio, servicio..." class="w-full px-4 py-2 border-2 border-lava-200 rounded-lg focus:border-lava-400 bg-white text-sm">
      </div>
    </div>

    <!-- Tabla -->
    <div class="main-container rounded-2xl shadow-lg p-4 animate-fade-in">
      <div class="overflow-x-auto">
        <table id="dataTable" class="display nowrap w-full"></table>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-lava-500 text-xs py-4">
      <p>LavaSmart &copy; 2025</p>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader">
    <div class="flex flex-col items-center">
      <div class="relative">
        <div class="w-14 h-14 border-4 border-lava-200 rounded-full"></div>
        <div class="w-14 h-14 border-4 border-lava-500 rounded-full border-t-transparent animate-spin absolute top-0 left-0"></div>
      </div>
      <span class="text-lava-600 font-medium mt-3">Cargando...</span>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal-overlay" class="hidden fixed inset-0 modal-overlay z-40"></div>
  <div id="modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
    <div class="modal-content rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-y-auto">
      <div id="modal-content" class="p-5"></div>
    </div>
  </div>
</body>
</html>
