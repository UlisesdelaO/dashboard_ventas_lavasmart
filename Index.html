<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Datos | LavaSmart</title>
  <base target="_top">

  <!-- Google Fonts - Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'outfit': ['Outfit', 'sans-serif'],
          },
          colors: {
            'lava': {
              50: '#f0fdfa',
              100: '#ccfbf1',
              200: '#99f6e4',
              300: '#5eead4',
              400: '#2dd4bf',
              500: '#14b8a6',
              600: '#0d9488',
              700: '#0f766e',
              800: '#115e59',
              900: '#134e4a',
            }
          }
        }
      }
    }
  </script>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { font-family: 'Outfit', sans-serif; }
    body { 
      padding-top: 4.5rem;
      background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 50%, #99f6e4 100%);
      min-height: 100vh;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .main-container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }
    
    .kpi-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,253,250,0.95) 100%);
      transition: all 0.3s ease;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(13, 148, 136, 0.1);
    }
    
    /* DataTable Styles */
    table.dataTable {
      border-collapse: collapse !important;
      width: 100% !important;
    }
    table.dataTable thead th {
      background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%) !important;
      color: white !important;
      font-weight: 600 !important;
      padding: 14px 16px !important;
      border: none !important;
      font-size: 13px !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }
    table.dataTable tbody tr {
      transition: all 0.2s ease;
    }
    table.dataTable tbody tr:nth-child(even) {
      background-color: #f0fdfa !important;
    }
    table.dataTable tbody tr:hover {
      background-color: #ccfbf1 !important;
      cursor: pointer;
    }
    table.dataTable tbody td {
      color: #115e59 !important;
      padding: 12px 16px !important;
      border-bottom: 1px solid #e5e7eb !important;
      font-size: 14px !important;
    }
    
    .dataTables_wrapper .dataTables_filter input {
      border: 2px solid #e5e7eb !important;
      border-radius: 8px !important;
      padding: 8px 12px !important;
      margin-left: 8px !important;
      transition: all 0.3s ease !important;
    }
    .dataTables_wrapper .dataTables_filter input:focus {
      border-color: #14b8a6 !important;
      outline: none !important;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1) !important;
    }
    
    .dataTables_wrapper .dataTables_length select {
      border: 2px solid #e5e7eb !important;
      border-radius: 8px !important;
      padding: 6px 30px 6px 12px !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      border-radius: 8px !important;
      margin: 0 2px !important;
      transition: all 0.2s ease !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%) !important;
      color: white !important;
      border: none !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%) !important;
      color: white !important;
      border: none !important;
    }
    
    .table-container::-webkit-scrollbar {
      height: 8px;
    }
    .table-container::-webkit-scrollbar-track {
      background: #f0fdfa;
      border-radius: 4px;
    }
    .table-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #0d9488, #14b8a6);
      border-radius: 4px;
    }
    
    .nav-link {
      position: relative;
      overflow: hidden;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: #0d9488;
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }
    .nav-link:hover::after,
    .nav-link.active::after {
      width: 80%;
    }
    
    .filter-btn {
      transition: all 0.2s ease;
    }
    .filter-btn:hover {
      transform: translateY(-1px);
    }
    .filter-btn:active {
      transform: translateY(0);
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    #loader {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(240, 253, 250, 0.95);
      backdrop-filter: blur(5px);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #loader.hidden { display: none; }
    
    /* Modal Styles */
    .modal-overlay {
      background: rgba(15, 118, 110, 0.3);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f0fdfa 100%);
    }
    .modal-section {
      background: rgba(240, 253, 250, 0.7);
      border: 1px solid rgba(20, 184, 166, 0.1);
    }
  </style>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <script>
    // Formatea fecha a "YYYY-MM-DD"
    function formatDateInput(date) {
      const yr = date.getFullYear();
      const mo = String(date.getMonth() + 1).padStart(2, '0');
      const da = String(date.getDate()).padStart(2, '0');
      return `${yr}-${mo}-${da}`;
    }
    
    function todayString() {
      return formatDateInput(new Date());
    }
    
    function daysAgoString(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return formatDateInput(d);
    }

    function showNotification(message, type) {
      var bgColor = type === 'error' ? 'bg-red-500' : 'bg-lava-500';
      var icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
      var notification = $('<div class="fixed top-20 right-4 ' + bgColor + ' text-white px-5 py-3 rounded-xl shadow-lg z-[1000] animate-fade-in flex items-center gap-3"><i class="fas ' + icon + '"></i>' + message + '</div>');
      $('body').append(notification);
      setTimeout(function() {
        notification.fadeOut(function() { $(this).remove(); });
      }, 3500);
    }

    function handleError(error) {
      console.error('Error:', error);
      $("#loader").addClass("hidden");
      showNotification('Error al cargar datos', 'error');
    }

    // Llama a getKpiData y getFilteredData según filtros
    function fetchAll(filterValue, startDate, endDate, filterType) {
      google.script.run
        .withSuccessHandler(showKpis)
        .withFailureHandler(handleError)
        .getKpiData(filterValue, startDate, endDate, filterType);
      google.script.run
        .withSuccessHandler(displayData)
        .withFailureHandler(handleError)
        .getFilteredData(filterValue, startDate, endDate, filterType);
    }

    function getCurrentFilters() {
      const isRange = $("#range-mode").is(":checked");
      return {
        text: $("#search-text").val().trim().toLowerCase(),
        day: $("#filter-day").val(),
        start: $("#filter-start").val(),
        end: $("#filter-end").val(),
        isRange: isRange
      };
    }

    // Cada vez que cambien filtros
    function onFilterChange() {
      $("#loader").removeClass("hidden");
      const filters = getCurrentFilters();

      if (filters.day && !filters.isRange) {
        fetchAll(filters.text, filters.day, "", "day");
      } else if (filters.isRange) {
        fetchAll(filters.text, filters.start, filters.end, "range");
      } else {
        fetchAll("", "", "", "all");
      }
    }

    // Muestra los KPIs
    function showKpis(kpiObj) {
      animateNumber("#kpi-total", kpiObj.totalRecords, false);
      animateNumber("#kpi-total-revenue", kpiObj.totalRevenue, true);
      animateNumber("#kpi-avg-revenue", kpiObj.avgRevenue, true);
      animateNumber("#kpi-pending", kpiObj.pendingCount, false);
    }

    function animateNumber(selector, target, isCurrency) {
      var $el = $(selector);
      var current = 0;
      var duration = 800;
      var steps = 25;
      var increment = target / steps;
      var interval = duration / steps;
      
      var timer = setInterval(function() {
        current += increment;
        if (current >= target) {
          current = target;
          clearInterval(timer);
        }
        if (isCurrency) {
          $el.text(Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(current));
        } else {
          $el.text(Math.round(current).toLocaleString('es-MX'));
        }
      }, interval);
    }

    // Construye la tabla DataTable
    function displayData(jsonData) {
      $("#loader").addClass("hidden");
      
      let parsedData;
      try {
        parsedData = JSON.parse(jsonData);
      } catch (e) {
        console.error('Error parsing data:', e);
        parsedData = [];
      }

      const headers = [
        { text: "Folio", always: true },
        { text: "Fecha", always: true },
        { text: "Cliente", always: false },
        { text: "Teléfono", always: false },
        { text: "Servicio", always: false },
        { text: "Costo Base", always: false },
        { text: "Monto", always: true },
        { text: "Estado", always: false }
      ];

      let thead = `<thead><tr>`;
      headers.forEach(col => {
        const hideClass = col.always ? '' : 'hidden md:table-cell';
        thead += `<th class="${hideClass}">${col.text}</th>`;
      });
      thead += `</tr></thead><tbody>`;

      let tbody = "";
      parsedData.forEach((row, idx) => {
        tbody += `<tr data-row-index="${idx}">`;
        tbody += `<td><span class="font-medium text-lava-700">${row[0] || ""}</span></td>`;
        tbody += `<td>${row[1] || ""}</td>`;
        tbody += `<td class="hidden md:table-cell">${row[2] || ""}</td>`;
        tbody += `<td class="hidden md:table-cell">${row[3] || ""}</td>`;
        tbody += `<td class="hidden md:table-cell max-w-[200px] truncate">${row[27] || ""}</td>`;
        tbody += `<td class="hidden md:table-cell">${row[13] || ""}</td>`;
        tbody += `<td><span class="font-semibold text-lava-700">${row[8] || ""}</span></td>`;
        tbody += `<td class="hidden md:table-cell">
          <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(row[33])}">
            ${row[33] || "—"}
          </span>
        </td>`;
        tbody += `</tr>`;
      });
      
      const tableHTML = thead + tbody + `</tbody>`;
      $("#dataTable").html(tableHTML);

      if ($.fn.DataTable.isDataTable("#dataTable")) {
        window.myDataTable.destroy();
      }
      
      window.myDataTable = $("#dataTable").DataTable({
        order: [[1, 'desc']],
        pageLength: 25,
        responsive: true,
        autoWidth: false,
        language: {
          search: "",
          searchPlaceholder: "Buscar en tabla...",
          lengthMenu: "Mostrar _MENU_",
          paginate: {
            first: '<i class="fas fa-angle-double-left"></i>',
            last: '<i class="fas fa-angle-double-right"></i>',
            next: '<i class="fas fa-angle-right"></i>',
            previous: '<i class="fas fa-angle-left"></i>'
          },
          info: "_START_ - _END_ de _TOTAL_",
          infoEmpty: "Sin registros",
          zeroRecords: "No se encontraron resultados"
        }
      });

      window.originalTableData = parsedData;
      $("#dataTable tbody").off("click").on("click", "tr", function() {
        const rowIndex = $(this).data("row-index");
        if (rowIndex !== undefined) {
          openModal(rowIndex);
        }
      });
    }

    function getStatusClass(status) {
      if (!status) return 'bg-gray-100 text-gray-600';
      const s = status.toString().toLowerCase();
      if (s.includes('completado') || s.includes('realizado')) return 'bg-green-100 text-green-700';
      if (s.includes('pendiente')) return 'bg-amber-100 text-amber-700';
      if (s.includes('cancelado')) return 'bg-red-100 text-red-700';
      if (s.includes('proceso') || s.includes('progreso')) return 'bg-blue-100 text-blue-700';
      return 'bg-gray-100 text-gray-600';
    }

    // Modal de detalles
    function openModal(idx) {
      const data = window.originalTableData[idx];
      const ubic = [data[34], data[35], data[36], data[37], data[38]]
                    .filter(v => v && v.toString().trim() !== "")
                    .join(", ");
      
      let html = `
        <div class="flex justify-between items-center border-b border-lava-200 pb-4 mb-6">
          <h3 class="text-2xl font-bold text-lava-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-lava-100 rounded-xl flex items-center justify-center">
              <i class="fas fa-file-alt text-lava-600"></i>
            </div>
            Folio: ${data[0] || "—"}
          </h3>
          <button id="modal-close-btn" class="w-10 h-10 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-all flex items-center justify-center">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>

        <!-- Info Básica -->
        <section class="modal-section rounded-xl p-5 mb-4">
          <h4 class="text-base font-semibold text-lava-700 mb-4 flex items-center gap-2">
            <i class="fas fa-user text-lava-500"></i> Información del Cliente
          </h4>
          <div class="grid grid-cols-2 gap-4">
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Fecha</span><p class="font-medium text-lava-800">${data[1] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Hora</span><p class="font-medium text-lava-800">${data[31] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Cliente</span><p class="font-medium text-lava-800">${data[2] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Teléfono</span><p class="font-medium text-lava-800">${data[3] || "—"}</p></div>
          </div>
        </section>

        <!-- Costos -->
        <section class="modal-section rounded-xl p-5 mb-4">
          <h4 class="text-base font-semibold text-lava-700 mb-4 flex items-center gap-2">
            <i class="fas fa-dollar-sign text-lava-500"></i> Costos
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Cotizado</span><p class="font-medium text-lava-800">${data[4] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Adicionales</span><p class="font-medium text-lava-800">${data[5] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Propinas</span><p class="font-medium text-lava-800">${data[6] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Diferencia</span><p class="font-medium text-lava-800">${data[7] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Costo Base</span><p class="font-medium text-lava-800">${data[13] || "—"}</p></div>
            <div class="bg-lava-50 rounded-lg p-3 -m-1">
              <span class="text-xs text-lava-600 uppercase tracking-wide font-semibold">Total</span>
              <p class="font-bold text-xl text-lava-700">${data[8] || "—"}</p>
            </div>
          </div>
        </section>

        <!-- Pago -->
        <section class="modal-section rounded-xl p-5 mb-4">
          <h4 class="text-base font-semibold text-lava-700 mb-4 flex items-center gap-2">
            <i class="fas fa-credit-card text-lava-500"></i> Información de Pago
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Tipo Venta</span><p class="font-medium text-lava-800">${data[14] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Método Pago</span><p class="font-medium text-lava-800">${data[15] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Estado Pago</span><p class="font-medium text-lava-800">${data[16] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Banco</span><p class="font-medium text-lava-800">${data[17] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Terminación</span><p class="font-medium text-lava-800">${data[18] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Referencia</span><p class="font-medium text-lava-800">${data[19] || "—"}</p></div>
          </div>
        </section>

        <!-- Servicio -->
        <section class="modal-section rounded-xl p-5 mb-4">
          <h4 class="text-base font-semibold text-lava-700 mb-4 flex items-center gap-2">
            <i class="fas fa-tools text-lava-500"></i> Detalles del Servicio
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Servicio(s)</span><p class="font-medium text-lava-800">${data[27] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Estado</span>
              <span class="inline-block mt-1 px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(data[33])}">${data[33] || "—"}</span>
            </div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Vendedor</span><p class="font-medium text-lava-800">${data[32] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Técnico 1</span><p class="font-medium text-lava-800">${data[21] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Técnico 2</span><p class="font-medium text-lava-800">${data[22] || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Unidad</span><p class="font-medium text-lava-800">${data[20] || "—"}</p></div>
          </div>
          ${data[28] ? `<div class="mt-4"><span class="text-xs text-gray-500 uppercase tracking-wide">Comentarios</span><p class="font-medium text-lava-800 mt-1">${data[28]}</p></div>` : ''}
        </section>

        <!-- Ubicación -->
        <section class="modal-section rounded-xl p-5">
          <h4 class="text-base font-semibold text-lava-700 mb-4 flex items-center gap-2">
            <i class="fas fa-map-marker-alt text-lava-500"></i> Ubicación
          </h4>
          <div class="grid grid-cols-2 gap-4">
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Dirección</span><p class="font-medium text-lava-800">${ubic || "—"}</p></div>
            <div><span class="text-xs text-gray-500 uppercase tracking-wide">Coordenadas</span><p class="font-medium text-lava-800">${data[39] || "—"}</p></div>
            ${data[40] ? `<div class="col-span-2"><span class="text-xs text-gray-500 uppercase tracking-wide">Referencias</span><p class="font-medium text-lava-800">${data[40]}</p></div>` : ''}
          </div>
        </section>
      `;
      
      $("#modal-content").html(html);
      $("#modal-overlay, #modal").removeClass("hidden");
      $("#modal-close-btn").on("click", closeModal);
      
      // Close on escape
      $(document).on("keydown.modal", function(e) {
        if (e.key === "Escape") closeModal();
      });
    }
    
    function closeModal() {
      $("#modal-overlay, #modal").addClass("hidden");
      $("#modal-content").empty();
      $(document).off("keydown.modal");
    }

    // Export to CSV
    function exportToCSV() {
      const filters = getCurrentFilters();
      let filterValue = filters.text;
      let startDate = filters.isRange ? filters.start : filters.day;
      let endDate = filters.isRange ? filters.end : "";
      let filterType = filters.isRange ? "range" : (filters.day ? "day" : "all");
      
      showNotification('Generando archivo CSV...', 'success');
      
      google.script.run
        .withSuccessHandler(function(csv) {
          if (!csv) {
            showNotification('No hay datos para exportar', 'error');
            return;
          }
          
          // Create and download file
          const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'lavasmart_datos_' + todayString() + '.csv';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          showNotification('Archivo descargado correctamente', 'success');
        })
        .withFailureHandler(function(error) {
          showNotification('Error al exportar: ' + error.message, 'error');
        })
        .exportToCSV(filterValue, startDate, endDate, filterType);
    }

    // Función para navegar en iframe usando replace para evitar pantalla en blanco
    function navigateToPage(page) {
      try {
        var currentUrl = window.location.href;
        var baseUrl = currentUrl.split('?')[0]; // Obtener URL sin parámetros
        var newUrl = page === 'dashboard' ? baseUrl + '?page=dashboard' : baseUrl;
        
        // Usar replace en lugar de href para evitar problemas en iframe
        window.location.replace(newUrl);
      } catch (e) {
        console.error('Error en navegación:', e);
        // Fallback: recargar con parámetros
        if (page === 'dashboard') {
          window.location.search = '?page=dashboard';
        } else {
          window.location.search = '';
        }
      }
    }

    // Al cargar página
    $(document).ready(function() {
      // Quick filter buttons
      $("#btn-yesterday").on("click", () => {
        const yd = daysAgoString(1);
        $("#filter-day").val(yd);
        $("#range-mode").prop("checked", false);
        updateFilterState();
        onFilterChange();
      });
      
      $("#btn-today").on("click", () => {
        const td = todayString();
        $("#filter-day").val(td);
        $("#range-mode").prop("checked", false);
        updateFilterState();
        onFilterChange();
      });
      
      $("#btn-week").on("click", () => {
        const start = daysAgoString(7);
        const end = todayString();
        $("#filter-start").val(start);
        $("#filter-end").val(end);
        $("#range-mode").prop("checked", true);
        updateFilterState();
        onFilterChange();
      });
      
      $("#btn-month").on("click", () => {
        const start = daysAgoString(30);
        const end = todayString();
        $("#filter-start").val(start);
        $("#filter-end").val(end);
        $("#range-mode").prop("checked", true);
        updateFilterState();
        onFilterChange();
      });

      // Day navigation
      $("#btn-prev-day").on("click", () => {
        let current = $("#filter-day").val();
        if (!current) current = todayString();
        const d = new Date(current + 'T12:00:00');
        d.setDate(d.getDate() - 1);
        const newDate = formatDateInput(d);
        $("#filter-day").val(newDate);
        $("#range-mode").prop("checked", false);
        updateFilterState();
        onFilterChange();
      });
      
      $("#btn-next-day").on("click", () => {
        let current = $("#filter-day").val();
        if (!current) current = todayString();
        const d = new Date(current + 'T12:00:00');
        d.setDate(d.getDate() + 1);
        const newDate = formatDateInput(d);
        $("#filter-day").val(newDate);
        $("#range-mode").prop("checked", false);
        updateFilterState();
        onFilterChange();
      });

      // Range mode toggle
      $("#range-mode").on("change", () => {
        updateFilterState();
        onFilterChange();
      });

      function updateFilterState() {
        const isRange = $("#range-mode").is(":checked");
        $("#filter-day").prop("disabled", isRange);
        $("#filter-start, #filter-end").prop("disabled", !isRange);
        
        // Visual feedback
        if (isRange) {
          $("#filter-day").addClass("opacity-50");
          $("#filter-start, #filter-end").removeClass("opacity-50");
        } else {
          $("#filter-day").removeClass("opacity-50");
          $("#filter-start, #filter-end").addClass("opacity-50");
        }
      }

      // Date change handlers
      $("#filter-day").on("change", () => {
        $("#range-mode").prop("checked", false);
        updateFilterState();
        onFilterChange();
      });
      
      $("#filter-start, #filter-end").on("change", () => {
        $("#range-mode").prop("checked", true);
        updateFilterState();
        onFilterChange();
      });

      // Clear filters
      $("#clear-filter-btn").on("click", function() {
        $("#filter-day").val("");
        $("#search-text").val("");
        $("#filter-start").val("");
        $("#filter-end").val("");
        $("#range-mode").prop("checked", false);
        updateFilterState();
        onFilterChange();
      });

      // Export button
      $("#btn-export").on("click", exportToCSV);

      // Modal overlay click
      $("#modal-overlay").on("click", closeModal);

      // Initial state
      updateFilterState();
      
      // Initial load - today's data
      const today = todayString();
      $("#filter-day").val(today);
      onFilterChange();
    });
  </script>
</head>

<body class="min-h-screen">
  <!-- Navbar -->
  <nav class="fixed top-0 left-0 w-full glass-card z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <!-- Logo -->
      <a href="javascript:void(0)" onclick="navigateToPage('')" class="flex items-center gap-3 group cursor-pointer">
        <div class="w-10 h-10 bg-gradient-to-br from-lava-500 to-lava-700 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-lava-500/30 transition-all">
          <i class="fas fa-tint text-white text-lg"></i>
        </div>
        <span class="text-xl font-bold bg-gradient-to-r from-lava-700 to-lava-500 bg-clip-text text-transparent">
          LavaSmart
        </span>
      </a>
      
      <!-- Nav Links -->
      <div class="flex items-center gap-2">
        <a href="javascript:void(0)" onclick="navigateToPage('')"
           class="nav-link active px-4 py-2 rounded-lg text-sm font-medium text-white bg-gradient-to-r from-lava-600 to-lava-500 shadow-md cursor-pointer">
          <i class="fas fa-table mr-2"></i>Consulta
        </a>
        <a href="javascript:void(0)" onclick="navigateToPage('dashboard')"
           class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-lava-700 hover:bg-lava-50 transition-all cursor-pointer">
          <i class="fas fa-chart-line mr-2"></i>Dashboard
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6 animate-fade-in">
      <h1 class="text-3xl md:text-4xl font-bold text-lava-800 mb-2">
        Consulta de Datos
      </h1>
      <p class="text-lava-600">Busca y filtra los registros de servicios</p>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="kpi-card rounded-xl shadow-md p-4 animate-fade-in" style="animation-delay: 0.1s">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lava-600 text-xs font-medium uppercase tracking-wide">Registros</span>
          <i class="fas fa-clipboard-list text-lava-400"></i>
        </div>
        <span id="kpi-total" class="text-2xl font-bold text-lava-800">0</span>
      </div>
      
      <div class="kpi-card rounded-xl shadow-md p-4 animate-fade-in" style="animation-delay: 0.15s">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lava-600 text-xs font-medium uppercase tracking-wide">Ingreso</span>
          <i class="fas fa-dollar-sign text-emerald-400"></i>
        </div>
        <span id="kpi-total-revenue" class="text-2xl font-bold text-lava-800">$0</span>
      </div>
      
      <div class="kpi-card rounded-xl shadow-md p-4 animate-fade-in" style="animation-delay: 0.2s">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lava-600 text-xs font-medium uppercase tracking-wide">Promedio</span>
          <i class="fas fa-chart-bar text-cyan-400"></i>
        </div>
        <span id="kpi-avg-revenue" class="text-2xl font-bold text-lava-800">$0</span>
      </div>
      
      <div class="kpi-card rounded-xl shadow-md p-4 animate-fade-in" style="animation-delay: 0.25s">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lava-600 text-xs font-medium uppercase tracking-wide">Pendientes</span>
          <i class="fas fa-clock text-amber-400"></i>
        </div>
        <span id="kpi-pending" class="text-2xl font-bold text-lava-800">0</span>
      </div>
    </div>

    <!-- Filters Card -->
    <div class="main-container rounded-2xl shadow-lg p-5 mb-6 animate-fade-in" style="animation-delay: 0.3s">
      <!-- Quick Filters -->
      <div class="flex flex-wrap items-center gap-2 mb-5">
        <span class="text-sm font-medium text-lava-700 mr-2">Filtros rápidos:</span>
        <button id="btn-yesterday" class="filter-btn px-4 py-2 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-sm font-medium">
          Ayer
        </button>
        <button id="btn-today" class="filter-btn px-4 py-2 bg-lava-500 text-white rounded-lg hover:bg-lava-600 text-sm font-medium shadow-md">
          Hoy
        </button>
        <button id="btn-week" class="filter-btn px-4 py-2 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-sm font-medium">
          Última Semana
        </button>
        <button id="btn-month" class="filter-btn px-4 py-2 bg-lava-50 text-lava-700 rounded-lg hover:bg-lava-100 text-sm font-medium">
          Último Mes
        </button>
        
        <div class="flex items-center gap-1 ml-2">
          <button id="btn-prev-day" class="filter-btn w-9 h-9 bg-white border-2 border-lava-200 rounded-lg hover:border-lava-400 flex items-center justify-center">
            <i class="fas fa-chevron-left text-lava-600 text-sm"></i>
          </button>
          <button id="btn-next-day" class="filter-btn w-9 h-9 bg-white border-2 border-lava-200 rounded-lg hover:border-lava-400 flex items-center justify-center">
            <i class="fas fa-chevron-right text-lava-600 text-sm"></i>
          </button>
        </div>
      </div>

      <!-- Filter Inputs -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
        <div class="md:col-span-3">
          <label class="block text-xs font-medium text-lava-600 mb-1.5 uppercase tracking-wide">
            Filtrar por día
          </label>
          <input type="date" id="filter-day"
                 class="w-full px-4 py-2.5 border-2 border-lava-200 rounded-xl focus:outline-none focus:border-lava-400 bg-white text-lava-800 font-medium transition-all">
        </div>
        
        <div class="md:col-span-1 flex items-center justify-center">
          <label class="flex items-center gap-2 cursor-pointer">
            <input id="range-mode" type="checkbox" class="w-4 h-4 text-lava-500 border-lava-300 rounded focus:ring-lava-400">
            <span class="text-xs font-medium text-lava-600 uppercase">Rango</span>
          </label>
        </div>
        
        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-lava-600 mb-1.5 uppercase tracking-wide">
            Fecha inicio
          </label>
          <input type="date" id="filter-start" disabled
                 class="w-full px-4 py-2.5 border-2 border-lava-200 rounded-xl focus:outline-none focus:border-lava-400 bg-white text-lava-800 font-medium transition-all opacity-50">
        </div>
        
        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-lava-600 mb-1.5 uppercase tracking-wide">
            Fecha fin
          </label>
          <input type="date" id="filter-end" disabled
                 class="w-full px-4 py-2.5 border-2 border-lava-200 rounded-xl focus:outline-none focus:border-lava-400 bg-white text-lava-800 font-medium transition-all opacity-50">
        </div>
        
        <div class="md:col-span-2">
          <label class="block text-xs font-medium text-lava-600 mb-1.5 uppercase tracking-wide">
            Buscar texto
          </label>
          <input type="text" id="search-text" placeholder="Cliente, folio..."
                 class="w-full px-4 py-2.5 border-2 border-lava-200 rounded-xl focus:outline-none focus:border-lava-400 bg-white text-lava-800 transition-all">
        </div>
        
        <div class="md:col-span-2 flex gap-2">
          <button id="clear-filter-btn"
                  class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-times"></i>
            <span class="hidden sm:inline">Limpiar</span>
          </button>
          <button id="btn-export"
                  class="flex-1 px-4 py-2.5 bg-emerald-500 text-white font-medium rounded-xl hover:bg-emerald-600 transition-all shadow-md flex items-center justify-center gap-2">
            <i class="fas fa-download"></i>
            <span class="hidden sm:inline">CSV</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Table Card -->
    <div class="main-container rounded-2xl shadow-lg p-5 animate-fade-in" style="animation-delay: 0.4s">
      <div class="table-container overflow-x-auto">
        <table id="dataTable" class="display nowrap w-full"></table>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-lava-500 text-sm py-6">
      <p>LavaSmart &copy; 2025 — Dashboard de Ventas</p>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader">
    <div class="flex flex-col items-center">
      <div class="relative">
        <div class="w-16 h-16 border-4 border-lava-200 rounded-full"></div>
        <div class="w-16 h-16 border-4 border-lava-500 rounded-full border-t-transparent animate-spin absolute top-0 left-0"></div>
      </div>
      <span class="text-lava-600 font-medium text-lg mt-4">Cargando datos...</span>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal-overlay" class="hidden fixed inset-0 modal-overlay z-40"></div>
  <div id="modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
    <div class="modal-content rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div id="modal-content" class="p-6"></div>
    </div>
  </div>
</body>
</html>
