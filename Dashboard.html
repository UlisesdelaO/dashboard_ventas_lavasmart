<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Financiero | LavaSmart</title>
  <base target="_top">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'outfit': ['Outfit', 'sans-serif'] },
          colors: {
            'lava': { 50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a' }
          }
        }
      }
    }
  </script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { font-family: 'Outfit', sans-serif; }
    body { padding-top: 4.5rem; background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 50%, #99f6e4 100%); min-height: 100vh; }
    .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
    .kpi-card { background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(240,253,250,0.9) 100%); backdrop-filter: blur(10px); transition: all 0.3s ease; }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(13, 148, 136, 0.12); }
    .chart-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .summary-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,253,250,0.9) 100%); }
    .summary-card.today { border-left: 4px solid #14b8a6; }
    .summary-card.week { border-left: 4px solid #0ea5e9; }
    .summary-card.month { border-left: 4px solid #8b5cf6; }
    .summary-card.all { border-left: 4px solid #f59e0b; }
    
    #loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(240, 253, 250, 0.95); backdrop-filter: blur(5px); z-index: 999; display: flex; align-items: center; justify-content: center; }
    #loader.hidden { display: none; }
    
    .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    google.charts.load('current', {'packages':['corechart', 'bar']});
    google.charts.setOnLoadCallback(initDashboard);

    var chartsLoaded = 0;
    var totalCharts = 6;

    function initDashboard() {
      $("#loader").removeClass("hidden");
      chartsLoaded = 0;
      
      // Resumen financiero
      google.script.run.withSuccessHandler(showFinancialSummary).withFailureHandler(handleError).getFinancialSummary();
      
      // Gráficas
      google.script.run.withSuccessHandler(drawMonthlyTrendChart).withFailureHandler(handleError).getMonthlyTrendData();
      google.script.run.withSuccessHandler(drawPaymentMethodChart).withFailureHandler(handleError).getPaymentMethodData();
      google.script.run.withSuccessHandler(drawPaymentStatusChart).withFailureHandler(handleError).getPaymentStatusSummary();
      google.script.run.withSuccessHandler(drawSaleTypeChart).withFailureHandler(handleError).getSaleTypeData();
      google.script.run.withSuccessHandler(drawVendorChart).withFailureHandler(handleError).getVendorData();
      google.script.run.withSuccessHandler(drawTopServicesChart).withFailureHandler(handleError).getTopServicesData();
    }

    function handleError(error) {
      console.error('Error:', error);
      chartsLoaded++;
      checkAllChartsLoaded();
    }

    function checkAllChartsLoaded() {
      if (chartsLoaded >= totalCharts) $("#loader").addClass("hidden");
    }

    function showNotification(message, type) {
      var bgColor = type === 'error' ? 'bg-red-500' : 'bg-lava-500';
      var notification = $('<div class="fixed top-20 right-4 ' + bgColor + ' text-white px-5 py-3 rounded-lg shadow-lg z-50 animate-fade-in">' + message + '</div>');
      $('body').append(notification);
      setTimeout(function() { notification.fadeOut(function() { $(this).remove(); }); }, 3500);
    }

    function formatMoney(n) {
      if (n >= 1000000) return '$' + (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return '$' + (n / 1000).toFixed(1) + 'K';
      return '$' + n.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function showFinancialSummary(summary) {
      // Hoy
      $("#sum-today-revenue").text(formatMoney(summary.today.revenue));
      $("#sum-today-paid").text(formatMoney(summary.today.paid));
      $("#sum-today-pending").text(formatMoney(summary.today.pending));
      $("#sum-today-count").text(summary.today.count);
      
      // Esta semana
      $("#sum-week-revenue").text(formatMoney(summary.thisWeek.revenue));
      $("#sum-week-paid").text(formatMoney(summary.thisWeek.paid));
      $("#sum-week-pending").text(formatMoney(summary.thisWeek.pending));
      $("#sum-week-count").text(summary.thisWeek.count);
      
      // Este mes
      $("#sum-month-revenue").text(formatMoney(summary.thisMonth.revenue));
      $("#sum-month-paid").text(formatMoney(summary.thisMonth.paid));
      $("#sum-month-pending").text(formatMoney(summary.thisMonth.pending));
      $("#sum-month-count").text(summary.thisMonth.count);
      
      // Total histórico
      $("#sum-all-revenue").text(formatMoney(summary.allTime.revenue));
      $("#sum-all-paid").text(formatMoney(summary.allTime.paid));
      $("#sum-all-pending").text(formatMoney(summary.allTime.pending));
      $("#sum-all-count").text(summary.allTime.count);
      $("#sum-all-tips").text(formatMoney(summary.allTime.tips));
      
      // Comparativa mes anterior
      var growth = summary.lastMonth.revenue > 0 ? 
        ((summary.thisMonth.revenue - summary.lastMonth.revenue) / summary.lastMonth.revenue * 100).toFixed(1) : 0;
      var growthClass = growth >= 0 ? 'text-green-600' : 'text-red-600';
      var growthIcon = growth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
      $("#month-growth").html('<i class="fas ' + growthIcon + ' mr-1"></i>' + Math.abs(growth) + '% vs mes anterior').addClass(growthClass);
    }

    function drawMonthlyTrendChart(dataArray) {
      if (!dataArray || dataArray.length <= 1) { chartsLoaded++; checkAllChartsLoaded(); return; }
      
      var dataTable = google.visualization.arrayToDataTable(dataArray);
      var options = {
        curveType: 'function',
        legend: { position: 'bottom', textStyle: { fontSize: 11, fontName: 'Outfit' } },
        hAxis: { textStyle: { fontSize: 10, fontName: 'Outfit' }, slantedText: true },
        vAxis: { format: '$#,###', textStyle: { fontSize: 10, fontName: 'Outfit' }, gridlines: { color: '#e5e7eb' } },
        chartArea: { left: 70, top: 20, width: '85%', height: '65%' },
        colors: ['#0d9488', '#10b981', '#f59e0b'],
        backgroundColor: 'transparent',
        lineWidth: 2,
        pointSize: 4,
        animation: { startup: true, duration: 800, easing: 'out' }
      };
      new google.visualization.LineChart(document.getElementById('chart_monthly')).draw(dataTable, options);
      chartsLoaded++; checkAllChartsLoaded();
    }

    function drawPaymentMethodChart(dataArray) {
      if (!dataArray || dataArray.length <= 1) { chartsLoaded++; checkAllChartsLoaded(); return; }
      
      var dataTable = google.visualization.arrayToDataTable(dataArray);
      var options = {
        pieHole: 0.45,
        legend: { position: 'right', textStyle: { fontSize: 11, fontName: 'Outfit' } },
        chartArea: { left: 10, top: 10, width: '90%', height: '85%' },
        colors: ['#0d9488', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4', '#ccfbf1'],
        backgroundColor: 'transparent',
        pieSliceTextStyle: { color: 'white', fontSize: 10, fontName: 'Outfit' },
        animation: { startup: true, duration: 800, easing: 'out' }
      };
      new google.visualization.PieChart(document.getElementById('chart_payment')).draw(dataTable, options);
      chartsLoaded++; checkAllChartsLoaded();
    }

    function drawPaymentStatusChart(dataArray) {
      if (!dataArray || dataArray.length <= 1) { chartsLoaded++; checkAllChartsLoaded(); return; }
      
      // Convertir a formato para gráfica de barras
      var chartData = [["Estado", "Monto", { role: 'style' }]];
      for (var i = 1; i < dataArray.length; i++) {
        var status = dataArray[i][0];
        var amount = dataArray[i][2]; // Monto
        var color = '#0d9488';
        if (status.toLowerCase().includes('pagado') || status.toLowerCase().includes('cobrado')) color = '#10b981';
        else if (status.toLowerCase().includes('pendiente')) color = '#f59e0b';
        else if (status.toLowerCase().includes('cancelado')) color = '#ef4444';
        chartData.push([status, amount, color]);
      }
      
      var dataTable = google.visualization.arrayToDataTable(chartData);
      var options = {
        legend: { position: 'none' },
        hAxis: { format: '$#,###', textStyle: { fontSize: 10, fontName: 'Outfit' } },
        vAxis: { textStyle: { fontSize: 10, fontName: 'Outfit' } },
        chartArea: { left: 100, top: 10, width: '70%', height: '80%' },
        backgroundColor: 'transparent',
        bar: { groupWidth: '60%' },
        animation: { startup: true, duration: 800, easing: 'out' }
      };
      new google.visualization.BarChart(document.getElementById('chart_status')).draw(dataTable, options);
      chartsLoaded++; checkAllChartsLoaded();
    }

    function drawSaleTypeChart(dataArray) {
      if (!dataArray || dataArray.length <= 1) { chartsLoaded++; checkAllChartsLoaded(); return; }
      
      var dataTable = google.visualization.arrayToDataTable(dataArray);
      var options = {
        pieHole: 0,
        legend: { position: 'right', textStyle: { fontSize: 11, fontName: 'Outfit' } },
        chartArea: { left: 10, top: 10, width: '90%', height: '85%' },
        colors: ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'],
        backgroundColor: 'transparent',
        pieSliceTextStyle: { color: 'white', fontSize: 10, fontName: 'Outfit' },
        animation: { startup: true, duration: 800, easing: 'out' }
      };
      new google.visualization.PieChart(document.getElementById('chart_saletype')).draw(dataTable, options);
      chartsLoaded++; checkAllChartsLoaded();
    }

    function drawVendorChart(dataArray) {
      if (!dataArray || dataArray.length <= 1) { chartsLoaded++; checkAllChartsLoaded(); return; }
      
      var dataTable = google.visualization.arrayToDataTable(dataArray);
      var options = {
        legend: { position: 'none' },
        hAxis: { format: '$#,###', textStyle: { fontSize: 10, fontName: 'Outfit' } },
        vAxis: { textStyle: { fontSize: 10, fontName: 'Outfit' } },
        chartArea: { left: 90, top: 10, width: '75%', height: '80%' },
        colors: ['#14b8a6'],
        backgroundColor: 'transparent',
        bar: { groupWidth: '65%' },
        animation: { startup: true, duration: 800, easing: 'out' }
      };
      new google.visualization.BarChart(document.getElementById('chart_vendor')).draw(dataTable, options);
      chartsLoaded++; checkAllChartsLoaded();
    }

    function drawTopServicesChart(dataArray) {
      if (!dataArray || dataArray.length <= 1) { chartsLoaded++; checkAllChartsLoaded(); return; }
      
      // Tomar solo servicio e ingresos
      var chartData = [["Servicio", "Ingresos"]];
      for (var i = 1; i < Math.min(dataArray.length, 8); i++) {
        chartData.push([dataArray[i][0], dataArray[i][2]]);
      }
      
      var dataTable = google.visualization.arrayToDataTable(chartData);
      var options = {
        legend: { position: 'none' },
        hAxis: { format: '$#,###', textStyle: { fontSize: 10, fontName: 'Outfit' } },
        vAxis: { textStyle: { fontSize: 9, fontName: 'Outfit' } },
        chartArea: { left: 120, top: 10, width: '65%', height: '85%' },
        colors: ['#0ea5e9'],
        backgroundColor: 'transparent',
        bar: { groupWidth: '60%' },
        animation: { startup: true, duration: 800, easing: 'out' }
      };
      new google.visualization.BarChart(document.getElementById('chart_services')).draw(dataTable, options);
      chartsLoaded++; checkAllChartsLoaded();
    }

    function navigateToPage(page) {
      google.script.run
        .withSuccessHandler(function(baseUrl) {
          var url = page === 'dashboard' ? baseUrl + '?page=dashboard' : baseUrl;
          window.open(url, '_top');
        })
        .withFailureHandler(function(error) {
          window.open(page === 'dashboard' ? '?page=dashboard' : '?', '_top');
        })
        .getScriptUrl();
    }

    $(window).resize(function() {
      if (typeof google !== 'undefined' && google.visualization) initDashboard();
    });

    $(document).ready(function() {
      $("#btn-refresh").on("click", function() {
        initDashboard();
        showNotification('Datos actualizados', 'success');
      });
    });
  </script>
</head>

<body class="min-h-screen">
  <!-- Navbar -->
  <nav class="fixed top-0 left-0 w-full glass-card z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <button type="button" onclick="navigateToPage('')" class="flex items-center gap-3 group cursor-pointer bg-transparent border-none">
        <div class="w-10 h-10 bg-gradient-to-br from-lava-500 to-lava-700 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-tint text-white text-lg"></i></div>
        <span class="text-xl font-bold bg-gradient-to-r from-lava-700 to-lava-500 bg-clip-text text-transparent">LavaSmart</span>
      </button>
      <div class="flex items-center gap-2">
        <button type="button" onclick="navigateToPage('')" class="px-4 py-2 rounded-lg text-sm font-medium text-lava-700 hover:bg-lava-50 bg-transparent border-none"><i class="fas fa-table mr-2"></i>Consulta</button>
        <button type="button" onclick="navigateToPage('dashboard')" class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-gradient-to-r from-lava-600 to-lava-500 shadow-md border-none"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
        <button id="btn-refresh" type="button" class="ml-2 p-2 rounded-lg text-lava-600 hover:bg-lava-50" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6 animate-fade-in">
      <h1 class="text-2xl md:text-3xl font-bold text-lava-800 mb-1">Dashboard Financiero</h1>
      <p class="text-lava-600 text-sm flex items-center gap-2">
        <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
        Resumen en tiempo real para toma de decisiones
      </p>
    </div>

    <!-- Resumen Financiero por Período -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <!-- Hoy -->
      <div class="summary-card today rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.1s">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-lava-800">HOY</h3>
          <span class="text-xs text-gray-500"><span id="sum-today-count">0</span> servicios</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-xs text-gray-500">Ingresos</span><span id="sum-today-revenue" class="text-lg font-bold text-lava-700">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Cobrado</span><span id="sum-today-paid" class="font-semibold text-green-600">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Pendiente</span><span id="sum-today-pending" class="font-semibold text-amber-600">$0</span></div>
        </div>
      </div>
      
      <!-- Esta Semana -->
      <div class="summary-card week rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.15s">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-lava-800">ESTA SEMANA</h3>
          <span class="text-xs text-gray-500"><span id="sum-week-count">0</span> servicios</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-xs text-gray-500">Ingresos</span><span id="sum-week-revenue" class="text-lg font-bold text-lava-700">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Cobrado</span><span id="sum-week-paid" class="font-semibold text-green-600">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Pendiente</span><span id="sum-week-pending" class="font-semibold text-amber-600">$0</span></div>
        </div>
      </div>
      
      <!-- Este Mes -->
      <div class="summary-card month rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.2s">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-lava-800">ESTE MES</h3>
          <span class="text-xs text-gray-500"><span id="sum-month-count">0</span> servicios</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-xs text-gray-500">Ingresos</span><span id="sum-month-revenue" class="text-lg font-bold text-lava-700">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Cobrado</span><span id="sum-month-paid" class="font-semibold text-green-600">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Pendiente</span><span id="sum-month-pending" class="font-semibold text-amber-600">$0</span></div>
        </div>
        <div id="month-growth" class="text-xs mt-2"></div>
      </div>
      
      <!-- Total Histórico -->
      <div class="summary-card all rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.25s">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-lava-800">TOTAL HISTÓRICO</h3>
          <span class="text-xs text-gray-500"><span id="sum-all-count">0</span> servicios</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between"><span class="text-xs text-gray-500">Ingresos</span><span id="sum-all-revenue" class="text-lg font-bold text-lava-700">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Cobrado</span><span id="sum-all-paid" class="font-semibold text-green-600">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Pendiente</span><span id="sum-all-pending" class="font-semibold text-amber-600">$0</span></div>
          <div class="flex justify-between"><span class="text-xs text-gray-500">Propinas</span><span id="sum-all-tips" class="font-semibold text-cyan-600">$0</span></div>
        </div>
      </div>
    </div>

    <!-- Gráficas Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6">
      <!-- Tendencia Mensual -->
      <div class="chart-container rounded-xl shadow-lg p-4 animate-fade-in lg:col-span-2" style="animation-delay: 0.3s">
        <h3 class="text-sm font-semibold text-lava-800 mb-3 flex items-center gap-2"><i class="fas fa-chart-line text-lava-500"></i>Tendencia Mensual (Ingresos vs Cobrado vs Pendiente)</h3>
        <div id="chart_monthly" class="w-full h-[280px]"></div>
      </div>
      
      <!-- Métodos de Pago -->
      <div class="chart-container rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.35s">
        <h3 class="text-sm font-semibold text-lava-800 mb-3 flex items-center gap-2"><i class="fas fa-credit-card text-lava-500"></i>Por Método de Pago</h3>
        <div id="chart_payment" class="w-full h-[250px]"></div>
      </div>
      
      <!-- Estado de Pagos -->
      <div class="chart-container rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.4s">
        <h3 class="text-sm font-semibold text-lava-800 mb-3 flex items-center gap-2"><i class="fas fa-money-check-alt text-lava-500"></i>Por Estado de Pago</h3>
        <div id="chart_status" class="w-full h-[250px]"></div>
      </div>
      
      <!-- Tipo de Venta -->
      <div class="chart-container rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.45s">
        <h3 class="text-sm font-semibold text-lava-800 mb-3 flex items-center gap-2"><i class="fas fa-shopping-cart text-lava-500"></i>Por Tipo de Venta</h3>
        <div id="chart_saletype" class="w-full h-[250px]"></div>
      </div>
      
      <!-- Vendedores -->
      <div class="chart-container rounded-xl shadow-lg p-4 animate-fade-in" style="animation-delay: 0.5s">
        <h3 class="text-sm font-semibold text-lava-800 mb-3 flex items-center gap-2"><i class="fas fa-users text-lava-500"></i>Por Vendedor</h3>
        <div id="chart_vendor" class="w-full h-[250px]"></div>
      </div>
      
      <!-- Top Servicios -->
      <div class="chart-container rounded-xl shadow-lg p-4 animate-fade-in lg:col-span-2" style="animation-delay: 0.55s">
        <h3 class="text-sm font-semibold text-lava-800 mb-3 flex items-center gap-2"><i class="fas fa-star text-lava-500"></i>Top Servicios por Ingresos</h3>
        <div id="chart_services" class="w-full h-[280px]"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-lava-500 text-xs py-4">
      <p>LavaSmart Dashboard Financiero &copy; 2025</p>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader">
    <div class="flex flex-col items-center">
      <div class="relative">
        <div class="w-14 h-14 border-4 border-lava-200 rounded-full"></div>
        <div class="w-14 h-14 border-4 border-lava-500 rounded-full border-t-transparent animate-spin absolute top-0 left-0"></div>
      </div>
      <span class="text-lava-600 font-medium mt-3">Cargando dashboard...</span>
    </div>
  </div>
</body>
</html>
